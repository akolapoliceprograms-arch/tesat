<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard ‚Äì Certificate Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --emerald: #10b981;
            --emerald-dark: #059669;
            --blue: #3b82f6;
            --purple: #a855f7;
            --bg: #0a0a1e;
            --bg2: #0d0d24;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.38);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* ‚îÄ‚îÄ Login Overlay ‚îÄ‚îÄ */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px 36px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4);
        }

        .login-card h2 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .login-card p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .login-card input {
            width: 100%;
            padding: 13px 16px;
            font-size: 0.95rem;
            font-family: inherit;
            border: 1.5px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            outline: none;
            margin-bottom: 16px;
            transition: all 0.3s;
        }

        .login-card input:focus {
            border-color: rgba(16, 185, 129, 0.6);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .login-card button {
            width: 100%;
            padding: 13px;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: inherit;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--emerald), var(--emerald-dark));
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-card button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(16, 185, 129, 0.4);
        }

        .login-error {
            color: #f43f5e;
            font-size: 0.82rem;
            margin-top: 10px;
            display: none;
        }

        /* ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .topbar {
            background: rgba(10, 10, 30, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.15rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .topbar-title .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--emerald);
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.3
            }
        }

        .topbar-actions {
            display: flex;
            gap: 12px;
        }

        .topbar-btn {
            padding: 8px 18px;
            font-size: 0.82rem;
            font-weight: 600;
            font-family: inherit;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.3s;
        }

        .topbar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .topbar-btn.danger {
            border-color: rgba(244, 63, 94, 0.3);
            color: #f43f5e;
        }

        .topbar-btn.danger:hover {
            background: rgba(244, 63, 94, 0.15);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* ‚îÄ‚îÄ Stat Cards ‚îÄ‚îÄ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -30px;
            right: -30px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            opacity: 0.08;
        }

        .stat-card:nth-child(1)::before {
            background: var(--emerald);
        }

        .stat-card:nth-child(2)::before {
            background: var(--blue);
        }

        .stat-card:nth-child(3)::before {
            background: var(--purple);
        }

        .stat-card:nth-child(4)::before {
            background: #f59e0b;
        }

        .stat-card-label {
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .stat-card-value {
            font-family: 'Outfit', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: var(--emerald);
        }

        .stat-card:nth-child(2) .stat-card-value {
            color: var(--blue);
        }

        .stat-card:nth-child(3) .stat-card-value {
            color: var(--purple);
        }

        .stat-card:nth-child(4) .stat-card-value {
            color: #f59e0b;
        }

        /* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px 16px;
            font-size: 0.9rem;
            font-family: inherit;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: var(--glass-bg);
            color: #fff;
            outline: none;
        }

        .search-bar input::placeholder {
            color: var(--text-muted);
        }

        .search-bar input:focus {
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.08);
        }

        /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
        .table-wrapper {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            padding: 14px 16px;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.03);
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            white-space: nowrap;
        }

        tbody td {
            padding: 13px 16px;
            font-size: 0.85rem;
            color: var(--text-dim);
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            white-space: nowrap;
        }

        tbody tr:hover {
            background: rgba(16, 185, 129, 0.04);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 6px;
            background: rgba(16, 185, 129, 0.12);
            color: var(--emerald);
        }

        .name-cell {
            color: #fff;
            font-weight: 600;
        }

        .ip-cell {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: var(--blue);
        }

        .time-cell {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .topbar {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .container {
                padding: 20px 12px;
            }

            .table-wrapper {
                overflow-x: auto;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
        }
    </style>
</head>

<body>

    <!-- ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <h2>üîê Admin Access</h2>
            <p>Enter the admin key to access the dashboard</p>
            <input type="password" id="adminKeyInput" placeholder="Enter admin key ..." />
            <button id="loginBtn">Unlock Dashboard</button>
            <p class="login-error" id="loginError">‚ùå Invalid admin key. Try again.</p>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
    <div class="dashboard" id="dashboard">
        <div class="topbar">
            <div class="topbar-title">
                <span class="dot"></span>
                Admin Dashboard ‚Äì Certificate Tracker
            </div>
            <div class="topbar-actions">
                <button class="topbar-btn" id="refreshBtn">‚Üª Refresh</button>
                <button class="topbar-btn" id="exportBtn">üì• Export CSV</button>
                <button class="topbar-btn danger" id="clearBtn">üóë Clear All</button>
            </div>
        </div>

        <div class="container">
            <!-- Stat Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-label">Total Downloads</div>
                    <div class="stat-card-value" id="statTotal">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Unique IPs</div>
                    <div class="stat-card-value" id="statIPs">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Today's Downloads</div>
                    <div class="stat-card-value" id="statToday">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Mobile Users</div>
                    <div class="stat-card-value" id="statMobile">0</div>
                </div>
            </div>

            <!-- Search -->
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="üîç Search by name, IP, device ..." />
            </div>

            <!-- Table -->
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>IP Address</th>
                            <th>Browser</th>
                            <th>OS</th>
                            <th>Device</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
                <div class="empty-state" id="emptyState" style="display:none">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M9 12h6m-3-3v6m-7 4h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <p>No certificate downloads yet</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let adminKey = "";
        let allDownloads = [];

        // ‚îÄ‚îÄ Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const loginOverlay = document.getElementById("loginOverlay");
        const dashboard = document.getElementById("dashboard");
        const loginBtn = document.getElementById("loginBtn");
        const adminKeyInput = document.getElementById("adminKeyInput");
        const loginError = document.getElementById("loginError");

        adminKeyInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") loginBtn.click();
        });

        loginBtn.addEventListener("click", async () => {
            const key = adminKeyInput.value.trim();
            if (!key) return;

            try {
                const res = await fetch(`/api/downloads?key=${encodeURIComponent(key)}`);
                if (res.ok) {
                    adminKey = key;
                    loginOverlay.classList.add("hidden");
                    dashboard.classList.add("active");
                    loadData();
                    // Auto-refresh every 5 seconds
                    setInterval(loadData, 5000);
                } else {
                    loginError.style.display = "block";
                    adminKeyInput.style.borderColor = "rgba(244,63,94,0.6)";
                }
            } catch {
                loginError.textContent = "‚ùå Cannot connect to server.";
                loginError.style.display = "block";
            }
        });

        // ‚îÄ‚îÄ Load Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadData() {
            try {
                const res = await fetch(`/api/downloads?key=${encodeURIComponent(adminKey)}`);
                const data = await res.json();
                allDownloads = data.downloads || [];
                updateStats(allDownloads);
                renderTable(allDownloads);
            } catch (err) {
                console.error("Failed to load data:", err);
            }
        }

        // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateStats(downloads) {
            document.getElementById("statTotal").textContent = downloads.length;

            const uniqueIPs = new Set(downloads.map(d => d.ip));
            document.getElementById("statIPs").textContent = uniqueIPs.size;

            const today = new Date().toISOString().split("T")[0];
            const todayCount = downloads.filter(d => d.timestamp.startsWith(today)).length;
            document.getElementById("statToday").textContent = todayCount;

            const mobileCount = downloads.filter(d =>
                d.device && d.device !== "Desktop"
            ).length;
            document.getElementById("statMobile").textContent = mobileCount;
        }

        // ‚îÄ‚îÄ Render Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderTable(downloads) {
            const tbody = document.getElementById("tableBody");
            const emptyState = document.getElementById("emptyState");

            if (downloads.length === 0) {
                tbody.innerHTML = "";
                emptyState.style.display = "block";
                return;
            }

            emptyState.style.display = "none";
            tbody.innerHTML = downloads.map((d, i) => {
                const time = new Date(d.timestamp).toLocaleString("en-IN", {
                    dateStyle: "medium", timeStyle: "short"
                });
                return `
                    <tr>
                        <td><span class="badge">${downloads.length - i}</span></td>
                        <td class="name-cell">${escapeHtml(d.name)}</td>
                        <td class="ip-cell">${escapeHtml(d.ip)}</td>
                        <td>${escapeHtml(d.browser)}</td>
                        <td>${escapeHtml(d.os)}</td>
                        <td>${escapeHtml(d.device)}</td>
                        <td class="time-cell">${time}</td>
                    </tr>
                `;
            }).join("");
        }

        function escapeHtml(text) {
            const div = document.createElement("div");
            div.textContent = text || "";
            return div.innerHTML;
        }

        // ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById("searchInput").addEventListener("input", (e) => {
            const q = e.target.value.toLowerCase();
            if (!q) {
                renderTable(allDownloads);
                return;
            }
            const filtered = allDownloads.filter(d =>
                (d.name || "").toLowerCase().includes(q) ||
                (d.ip || "").toLowerCase().includes(q) ||
                (d.browser || "").toLowerCase().includes(q) ||
                (d.os || "").toLowerCase().includes(q) ||
                (d.device || "").toLowerCase().includes(q)
            );
            renderTable(filtered);
        });

        // ‚îÄ‚îÄ Refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById("refreshBtn").addEventListener("click", loadData);

        // ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById("exportBtn").addEventListener("click", () => {
            if (allDownloads.length === 0) return alert("No data to export.");
            const headers = ["#", "Name", "IP", "Browser", "OS", "Device", "Timestamp"];
            const rows = allDownloads.map((d, i) =>
                [i + 1, d.name, d.ip, d.browser, d.os, d.device, d.timestamp]
                    .map(v => `"${(v || "").toString().replace(/"/g, '""')}"`)
                    .join(",")
            );
            const csv = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `certificate_downloads_${new Date().toISOString().split("T")[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // ‚îÄ‚îÄ Clear All ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById("clearBtn").addEventListener("click", async () => {
            if (!confirm("‚ö†Ô∏è Are you sure you want to delete ALL download logs? This cannot be undone.")) return;
            try {
                const res = await fetch(`/api/downloads?key=${encodeURIComponent(adminKey)}`, { method: "DELETE" });
                if (res.ok) {
                    allDownloads = [];
                    updateStats(allDownloads);
                    renderTable(allDownloads);
                }
            } catch (err) {
                alert("Failed to clear data.");
            }
        });
    </script>
</body>

</html>